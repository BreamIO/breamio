<html>
	<head>
		<title>Bream IO Eriver Tracker Drawer</title>
		<script src="/api/eyestream.js"></script>
		<script>
			(function(exports, undefined) {
				"use strict";
				var Trail = function Trail(canvas) {
					var rect = canvas.getBoundingClientRect()
					this.width   = canvas.width  = rect.width
					this.height  = canvas.height = rect.height
					this.buffer  = []
					this.last    = null
					this.counter = 0
					this.context = canvas.getContext("2d")
					this.context.lineWidth = 0
					EyeStream.subscribe("tracker:etdata", 1, this.receive.bind(this))
				}

				Trail.tau = 2 * Math.PI
				Trail.radius = 20
				Trail.alpha = 0.9
				Trail.color = "255,0,0" // RGB notation, adds opacity later
				Trail.thickness = 1.0
				Trail.maxLength = 20

				Trail.prototype.receive = function receive(data) {
					this.buffer.push({
						x: data.Filtered.Xf * 0.97 * this.width,
						y: data.Filtered.Yf * 0.97 * this.height
					})
				}

				Trail.prototype.render = function render(timestamp) {
					// Cache frequently used variables
					var i, j, distance, factor, point, step,
					    width   = this.width,
					    height  = this.height,
					    image   = this.image,
					    context = this.context,
					    buffer  = [],
					    length  = 0,
					    last    = this.last,
					    angle   = { start: 0, end: 0 },
					    delta   = { x: 0, y: 0 }

					// Setup next iteration and truncate buffer
					this.requestID = window.requestAnimationFrame(this.render.bind(this))
			    this.buffer = this.buffer.slice(-Trail.maxLength)
			    length      = this.buffer.length

			    if (last === null) {
			    	if (length === 0) return
			    	last = this.buffer[length - 1]
			    }

			    if (this.buffer.length === 0) {
			    	this.buffer[0] = last
			    	length = 1
			    }

					for (i = 0; i < length; ++i) {
						point = this.buffer[i]
						// delta.x = point.x - last.x
						// delta.y = point.y - last.y

						// distance = Math.sqrt(delta.x * delta.x + delta.y * delta.y)
						// if (distance !== 0) {
						// 	step = distance / Trail.thickness

						// 	delta.x /= step
						// 	delta.y /= step

						// 	for (j = 0; j < distance; j += step) {
						// 		buffer.push({
						// 			x: last.x + delta.x,
						// 			y: last.y + delta.y
						// 		})
						// 	}
						// }
						buffer.push(point)
						last = point
					}

					length = buffer.length
					context.clearRect(0, 0, width, height)
					last = buffer[length - 1]

					for (i = length - 2; i >= 0; --i) {
						point = buffer[i]
						factor = (i+1) / length
						angle.start = Math.atan2(point.y - last.y, point.x - last.x) - Math.PI/2 + (1 - factor) * Math.PI/3
						angle.end = angle.start  + Math.PI - (1 - factor) * Math.PI/3

						// Draw the current point
						context.fillStyle = "rgba(" + Trail.color + "," + 0.5 * factor + ")"
						context.beginPath()
						context.arc(point.x, point.y, Trail.radius, angle.start, angle.end)
						context.lineTo(
							last.x + Trail.radius * Math.cos(angle.end),
							last.y + Trail.radius * Math.sin(angle.end)
						)
						context.arc(last.x, last.y, Trail.radius, angle.end, angle.start, true)
						context.closePath()
						context.fill()

						last = point
					}

					last = buffer[length - 1]
					context.strokeStyle = "rgb(" + Trail.color + ")"
					context.beginPath()
					context.arc(last.x, last.y, Trail.radius, 0, Trail.tau)
					context.stroke()

			    this.last = buffer[length - 1]
					this.counter++
				}

				Trail.prototype.stopAfter = function stopAfter(time) {
					var self = this
					// console.profile("Rendering")
					if (!this.requestID) this.render()
					setTimeout(function stop() {
						// console.profileEnd("Rendering")
						window.cancelAnimationFrame(self.requestID)
						EyeStream.socket.close()
					}, time || 12000)
				}

				var init = function init(event) {
					if (!EyeStream.connected) {
						setTimeout(init, 100)
						return
					}
					exports.trail = new Trail(document.getElementById("trail"))
					exports.trail.render()
				}

				document.addEventListener("DOMContentLoaded", init)
			})(window)
		</script>
		<style>
			html, body, canvas {
				width: 100%;
				height: 100%;
				margin: 0;
				padding: 0;
			}
		</style>
		<!-- <script>
			document.addEventListener("DOMContentLoaded", function(event) {
				"use strict"; // If you like all your code to be strict
				window.trail = document.getElementById("trail")
				window.trail.width  = window.innerWidth*0.97;
				window.trail.height = window.innerHeight*0.97;
				window.ctx = trail.getContext("2d")
				listen("ws://localhost:8080/api/json")
				setInterval(fade, 10)
			});

			var socket;
			function listen(addr) {
				'use strict';
				socket = new WebSocket(addr);
				socket.onopen = function() {
					'use strict';
					console.log("Socket opened.");
					socket.send(JSON.stringify({
						Event: "tracker:etdata",
						Subscribe: true,
						ID: {{.Id}}
						}));
				};

				socket.onmessage = function (message) {
					'use strict';
					var event = JSON.parse(message.data);
					// console.log(event);
					if (event.Error !== undefined && event.Error !== null) {
						console.log(event.Error);
						return;
					}
					if (event.Event === "tracker:etdata") {
						/*console.log({
								raw: event.Data,
								btoa: btoa(event.Data),
								atob: atob(event.Data)
							})*/
						var etdata = JSON.parse(atob(event.Data));
						render(etdata)
					}
				};

				socket.onclose = function() {
					'use strict';
					console.log("Socket closed.")
				};
			}

			function render(etdata) {
				'use strict';
				ctx.fillStyle = "#FF0000";
				ctx.beginPath();
				ctx.arc(trail.width*etdata.Filtered.Xf,
					trail.height*etdata.Filtered.Yf,
					10,0,2*Math.PI);
				ctx.fill();
			}

			function fade() {
				'use strict';
				ctx.fillStyle = "rgba(255,255,255,0.1)"
				ctx.fillRect(0,0,trail.width,trail.height)
			}
		</script> -->
	</head>
	<body>
		<canvas id="trail"></canvas>
	</body>
</html>
